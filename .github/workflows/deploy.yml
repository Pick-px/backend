name: Deploy to EKS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set deployment environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "namespace=nestjs-app-staging" >> $GITHUB_OUTPUT
            echo "image_tag=pr-${{ github.event.number }}-${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "namespace=nestjs-app" >> $GITHUB_OUTPUT
            echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Verify AWS Configuration
        run: |
          echo "ğŸ” AWS ì„¤ì • í™•ì¸..."
          aws sts get-caller-identity
          aws eks describe-cluster --name nestjs-cluster --region ap-northeast-2 --query 'cluster.status'

      - name: Install eksctl
        run: |
          # eksctl ì„¤ì¹˜
          curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
          sudo mv /tmp/eksctl /usr/local/bin
          eksctl version

      - name: Install kubectl
        run: |
          # kubectl ìµœì‹  ë²„ì „ ì„¤ì¹˜
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Verify GitHub Secrets
        run: |
          echo "ğŸ” GitHub Secrets ì¡´ì¬ ì—¬ë¶€ í™•ì¸..."

          # JWT_SECRET í™•ì¸ (ê°’ì€ ë…¸ì¶œí•˜ì§€ ì•ŠìŒ)
          if [ -z "$JWT_SECRET" ]; then
            echo "âŒ JWT_SECRETì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          else
            echo "âœ… JWT_SECRETì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
          fi

          # DATABASE_URL í™•ì¸
          if [ -z "$DATABASE_URL" ]; then
            echo "âŒ DATABASE_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          else
            echo "âœ… DATABASE_URLì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
          fi

          # REDIS_URL í™•ì¸
          if [ -z "$REDIS_URL" ]; then
            echo "âŒ REDIS_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          else
            echo "âœ… REDIS_URLì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
          fi
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}

      - name: Update kubeconfig and verify connection
        run: |
          echo "ğŸ”§ EKS kubeconfig ì„¤ì •..."
          aws eks update-kubeconfig --region ap-northeast-2 --name nestjs-cluster

          echo "ğŸ” í´ëŸ¬ìŠ¤í„° ì—°ê²° í…ŒìŠ¤íŠ¸..."
          kubectl cluster-info
          kubectl get nodes -o wide

          echo "ğŸ” í˜„ì¬ context í™•ì¸..."
          kubectl config current-context

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Verify ECR Repository
        run: |
          echo "ğŸ” ECR ë¦¬í¬ì§€í† ë¦¬ í™•ì¸..."
          aws ecr describe-repositories --repository-names nestjs-app --region ap-northeast-2 || {
            echo "âŒ ECR ë¦¬í¬ì§€í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤..."
            aws ecr create-repository --repository-name nestjs-app --region ap-northeast-2
          }

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: nestjs-app
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ..."
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "âœ… ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      - name: Install AWS Load Balancer Controller (if not exists)
        run: |
          echo "ğŸ” AWS Load Balancer Controller í™•ì¸..."
          if ! kubectl get deployment -n kube-system aws-load-balancer-controller > /dev/null 2>&1; then
            echo "ğŸ“¦ AWS Load Balancer Controller ì„¤ì¹˜ ì¤‘..."
            
            # Download IAM policy
            curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.7.2/docs/install/iam_policy.json
            
            # Create IAM policy (ignore if exists)
            aws iam create-policy \
              --policy-name AWSLoadBalancerControllerIAMPolicy \
              --policy-document file://iam_policy.json || echo "IAM ì •ì±…ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"
            
            # Create service account with eksctl
            eksctl create iamserviceaccount \
              --cluster=nestjs-cluster \
              --namespace=kube-system \
              --name=aws-load-balancer-controller \
              --role-name AmazonEKSLoadBalancerControllerRole \
              --attach-policy-arn=arn:aws:iam::863518449560:policy/AWSLoadBalancerControllerIAMPolicy \
              --approve \
              --region=ap-northeast-2 || echo "ì„œë¹„ìŠ¤ ê³„ì •ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"
            
            # Install cert-manager
            kubectl apply \
              --validate=false \
              -f https://github.com/jetstack/cert-manager/releases/download/v1.13.0/cert-manager.yaml
            
            # Wait for cert-manager
            echo "â³ cert-manager ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
            kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=cert-manager -n cert-manager --timeout=300s
            
            # Download and apply AWS Load Balancer Controller
            curl -Lo v2_7_2_full.yaml https://github.com/kubernetes-sigs/aws-load-balancer-controller/releases/download/v2.7.2/v2_7_2_full.yaml
            sed -i.bak -e 's|your-cluster-name|nestjs-cluster|' v2_7_2_full.yaml
            kubectl apply -f v2_7_2_full.yaml
            
            # Wait for controller to be ready
            echo "â³ AWS Load Balancer Controller ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
            kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=aws-load-balancer-controller -n kube-system --timeout=300s
          else
            echo "âœ… AWS Load Balancer Controllerê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
          fi

      - name: Install Metrics Server (if not exists)
        run: |
          echo "ğŸ” Metrics Server í™•ì¸..."
          if ! kubectl get deployment metrics-server -n kube-system > /dev/null 2>&1; then
            echo "ğŸ“Š Metrics Server ì„¤ì¹˜ ì¤‘..."
            kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
            
            # Wait for metrics server to be ready
            echo "â³ Metrics Server ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
            kubectl wait --for=condition=ready pod -l k8s-app=metrics-server -n kube-system --timeout=300s
          else
            echo "âœ… Metrics Serverê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
          fi
          
          # Metrics Server ìƒíƒœ í™•ì¸
          echo "ğŸ“Š Metrics Server ìƒíƒœ:"
          kubectl get deployment metrics-server -n kube-system
          kubectl top nodes || echo "âš ï¸ ë…¸ë“œ ë©”íŠ¸ë¦­ì„ ì•„ì§ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ì„¤ì¹˜ ì§í›„ ì •ìƒ)"

      - name: Deploy to EKS
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: nestjs-app
          IMAGE_TAG: ${{ steps.env.outputs.image_tag }}
          NAMESPACE: ${{ steps.env.outputs.namespace }}
          ENVIRONMENT: ${{ steps.env.outputs.environment }}
        run: |
          echo "ğŸš€ EKS ë°°í¬ ì‹œì‘... (í™˜ê²½: $ENVIRONMENT, ë„¤ì„ìŠ¤í˜ì´ìŠ¤: $NAMESPACE)"

          # Create namespace for staging if it's a PR
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "ğŸ“ ìŠ¤í…Œì´ì§• ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±..."
            kubectl create namespace $NAMESPACE --dry-run=client -o yaml | \
            kubectl apply -f -
            
            # ìŠ¤í…Œì´ì§• í™˜ê²½ì— TTL ë¼ë²¨ ì¶”ê°€ (24ì‹œê°„ í›„ ì •ë¦¬ ëŒ€ìƒ)
            # Unix íƒ€ì„ìŠ¤íƒ¬í”„ ì‚¬ìš© (ì½œë¡  ì—†ìŒ)
            TTL_TIMESTAMP=$(date -d '+24 hours' +%s)
            kubectl label namespace $NAMESPACE \
              staging.cleanup/ttl-unix=$TTL_TIMESTAMP \
              staging.cleanup/pr-number=${{ github.event.number }} \
              staging.cleanup/created-date=$(date +%Y-%m-%d) \
              --overwrite
            
            echo "âœ… ìŠ¤í…Œì´ì§• ë„¤ì„ìŠ¤í˜ì´ìŠ¤ TTL ì„¤ì •: $(date -d '+24 hours')"
          else
            echo "ğŸ“ í”„ë¡œë•ì…˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±..."
            kubectl apply -f k8s/namespace.yaml
          fi

          # Create or update secrets
          echo "ğŸ” ì‹œí¬ë¦¿ ìƒì„±/ì—…ë°ì´íŠ¸..."
          kubectl create secret generic app-secrets \
            --from-literal=database-url="${{ secrets.DATABASE_URL }}" \
            --from-literal=redis-url="${{ secrets.REDIS_URL }}" \
            --from-literal=jwt-secret="${{ secrets.JWT_SECRET }}" \
            --namespace=$NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f -

          # Debug: ì‹œí¬ë¦¿ í™•ì¸ (ê°’ì€ ë…¸ì¶œí•˜ì§€ ì•ŠìŒ)
          echo "ğŸ” ìƒì„±ëœ ì‹œí¬ë¦¿ í™•ì¸..."
          kubectl get secret app-secrets -n $NAMESPACE --no-headers
          kubectl describe secret app-secrets -n $NAMESPACE

          # Copy and update deployment files for the environment
          echo "ğŸ”„ ë°°í¬ íŒŒì¼ ì¤€ë¹„..."
          cp -r k8s k8s-temp

          # Update image in deployment
          sed -i "s|863518449560.dkr.ecr.ap-northeast-2.amazonaws.com/nestjs-app:latest|$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG|g" k8s-temp/deployment.yaml

          # Update namespace in all files
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            sed -i "s|namespace: nestjs-app|namespace: $NAMESPACE|g" k8s-temp/*.yaml
            sed -i "s|name: nestjs-app|name: nestjs-app-staging|g" k8s-temp/deployment.yaml
            sed -i "s|app: nestjs-app|app: nestjs-app-staging|g" k8s-temp/deployment.yaml
            sed -i "s|name: nestjs-service|name: nestjs-service-staging|g" k8s-temp/service.yaml
            sed -i "s|name: nestjs-hpa|name: nestjs-hpa-staging|g" k8s-temp/hpa.yaml
            sed -i "s|name: nestjs-app|name: nestjs-app-staging|g" k8s-temp/hpa.yaml
            sed -i "s|name: nestjs-ingress|name: nestjs-ingress-staging|g" k8s-temp/ingress.yaml
          fi

          # Deploy application
          echo "ğŸ“¦ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬..."
          kubectl apply -f k8s-temp/deployment.yaml
          kubectl apply -f k8s-temp/service.yaml
          kubectl apply -f k8s-temp/hpa.yaml

          # Ingress ë°°í¬ (ê¸°ì¡´ ALBë¥¼ EKS ì—°ê²° ALBë¡œ ëŒ€ì²´)
          if [[ "${{ github.event_name }}" != "pull_request" ]]; then
            echo "ğŸŒ Ingress ë°°í¬ ì¤‘... (ê¸°ì¡´ ALB ëŒ€ì²´)"
            kubectl apply -f k8s-temp/ingress.yaml
            
            # Ingress ìƒíƒœ í™•ì¸
            echo "â³ Ingress ìƒì„± ëŒ€ê¸° ì¤‘..."
            kubectl wait --for=condition=ready ingress/nestjs-ingress -n nestjs-app --timeout=300s || echo "Ingress ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼"
            
            # ALB ì •ë³´ ì¶œë ¥
            kubectl get ingress nestjs-ingress -n nestjs-app -o wide
          fi

          echo "âœ… ë¦¬ì†ŒìŠ¤ ë°°í¬ ì™„ë£Œ"

      - name: Monitor Deployment Progress
        run: |
          echo "ğŸ” ë°°í¬ ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§..."

          # Start rollout status check in background
          kubectl rollout status deployment/nestjs-app -n nestjs-app --timeout=600s &
          ROLLOUT_PID=$!

          # Monitor pods and logs in real-time
          echo "ğŸ“Š ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘..."
          for i in {1..10}; do
            echo "--- ì²´í¬ #$i ($(date '+%H:%M:%S')) ---"
            
            echo "Pod ìƒíƒœ:"
            kubectl get pods -n nestjs-app -l app=nestjs-app -o wide
            
            echo "ReplicaSet ìƒíƒœ:"
            kubectl get rs -n nestjs-app -l app=nestjs-app -o wide
            
            echo "ìµœê·¼ ì´ë²¤íŠ¸:"
            kubectl get events -n nestjs-app --field-selector involvedObject.kind=Pod --sort-by='.lastTimestamp' | tail -3
            
            # Get logs from any running pods
            PODS=$(kubectl get pods -n nestjs-app -l app=nestjs-app -o jsonpath='{.items[*].metadata.name}')
            if [ ! -z "$PODS" ]; then
              echo "í˜„ì¬ Pod ë¡œê·¸:"
              for pod in $PODS; do
                echo "--- $pod ë¡œê·¸ ---"
                kubectl logs $pod -n nestjs-app --tail=5 --since=30s 2>/dev/null || echo "ë¡œê·¸ ì—†ìŒ"
              done
            fi
            
            # Check if rollout is still running
            if ! kill -0 $ROLLOUT_PID 2>/dev/null; then
              echo "âœ… ë¡¤ì•„ì›ƒ ì™„ë£Œ!"
              break
            fi
            
            echo "â³ 20ì´ˆ í›„ ë‹¤ì‹œ í™•ì¸..."
            sleep 20
          done

          # Wait for rollout to complete
          wait $ROLLOUT_PID

      - name: Debug Deployment Issues
        if: failure()
        run: |
          echo "ğŸ” ===== ë°°í¬ ì‹¤íŒ¨ ë””ë²„ê¹… ====="

          echo "ğŸ“Š Deployment ìƒì„¸ ì •ë³´:"
          kubectl describe deployment nestjs-app -n nestjs-app

          echo ""
          echo "ğŸ“Š ReplicaSet ìƒíƒœ:"
          kubectl describe rs -n nestjs-app -l app=nestjs-app

          echo ""
          echo "ğŸš¨ ì‹¤íŒ¨í•œ Pod ìƒì„¸ ì •ë³´:"
          kubectl get pods -n nestjs-app -l app=nestjs-app -o wide

          # ê° Podì˜ ìƒì„¸ ì •ë³´ì™€ ë¡œê·¸ ì¶œë ¥
          PODS=$(kubectl get pods -n nestjs-app -l app=nestjs-app -o jsonpath='{.items[*].metadata.name}')
          for pod in $PODS; do
            echo ""
            echo "--- Pod: $pod ìƒì„¸ ì •ë³´ ---"
            kubectl describe pod $pod -n nestjs-app
            
            echo ""
            echo "--- Pod: $pod í˜„ì¬ ë¡œê·¸ ---"
            kubectl logs $pod -n nestjs-app --tail=50 || echo "í˜„ì¬ ë¡œê·¸ ì—†ìŒ"
            
            echo ""
            echo "--- Pod: $pod ì´ì „ ë¡œê·¸ ---"
            kubectl logs $pod -n nestjs-app --previous --tail=50 || echo "ì´ì „ ë¡œê·¸ ì—†ìŒ"
          done

          echo ""
          echo "ğŸ” ìµœê·¼ ì´ë²¤íŠ¸ (ìƒì„¸):"
          kubectl get events -n nestjs-app --sort-by='.lastTimestamp' | tail -20

          echo ""
          echo "ğŸ” í´ëŸ¬ìŠ¤í„° ë¦¬ì†ŒìŠ¤ ìƒíƒœ:"
          kubectl top nodes || echo "ë©”íŠ¸ë¦­ ì„œë²„ ì‚¬ìš© ë¶ˆê°€"
          kubectl describe nodes | grep -A 10 "Allocated resources" || echo "ë…¸ë“œ ë¦¬ì†ŒìŠ¤ ì •ë³´ ì—†ìŒ"

          echo ""
          echo "ğŸ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¦¬ì†ŒìŠ¤:"
          kubectl get all -n nestjs-app

          echo ""
          echo "ğŸ” Secret ë° ConfigMap ìƒíƒœ:"
          kubectl get secrets -n nestjs-app
          kubectl get configmaps -n nestjs-app

      - name: Post-Deployment Verification
        if: success()
        run: |
          echo "ğŸš€ ===== ë°°í¬ ì™„ë£Œ í™•ì¸ ====="

          echo "ğŸ“Š í´ëŸ¬ìŠ¤í„° ë…¸ë“œ ìƒíƒœ:"
          kubectl get nodes -o wide

          echo ""
          echo "ğŸš€ Pod ìƒíƒœ:"
          kubectl get pods -n nestjs-app -o wide

          echo ""
          echo "ğŸŒ ì„œë¹„ìŠ¤ ìƒíƒœ:"
          kubectl get svc -n nestjs-app

          echo ""
          echo "ğŸ”— Ingress ìƒíƒœ:"
          kubectl get ingress -n nestjs-app

          echo ""
          echo "ğŸ“ ìµœê·¼ ì´ë²¤íŠ¸:"
          kubectl get events -n nestjs-app --sort-by='.lastTimestamp' | tail -10

          echo ""
          echo "ğŸ¥ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ (ë§ˆì§€ë§‰ 20ì¤„):"
          kubectl logs -n nestjs-app deployment/nestjs-app --tail=20 || echo "ë¡œê·¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

          echo ""
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ WebSocket: https://ws.pick-px.com"
