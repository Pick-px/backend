name: Cleanup Staging Environment

on:
  pull_request:
    types: [closed]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œì— TTL ë§Œë£Œëœ ìŠ¤í…Œì´ì§• í™˜ê²½ ì •ë¦¬
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  EKS_CLUSTER_NAME: nestjs-cluster
  ECR_REPOSITORY: nestjs-app

jobs:
  cleanup:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}

      - name: Cleanup specific PR staging environment
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ§¹ PR #${{ github.event.number }} ìŠ¤í…Œì´ì§• í™˜ê²½ ì •ë¦¬ ì¤‘..."
          
          STAGING_NAMESPACE="nestjs-app-staging"
          
          if kubectl get namespace $STAGING_NAMESPACE > /dev/null 2>&1; then
            echo "ğŸ“¦ ìŠ¤í…Œì´ì§• ë¦¬ì†ŒìŠ¤ ì‚­ì œ ì¤‘..."
            
            # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì •ë³´ ì¶œë ¥
            kubectl get namespace $STAGING_NAMESPACE --show-labels
            
            # ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì‚­ì œ
            kubectl delete all --all -n $STAGING_NAMESPACE --timeout=300s || echo "ë¦¬ì†ŒìŠ¤ ì‚­ì œ ì‹¤íŒ¨"
            kubectl delete secrets --all -n $STAGING_NAMESPACE --timeout=60s || echo "ì‹œí¬ë¦¿ ì‚­ì œ ì‹¤íŒ¨"
            kubectl delete configmaps --all -n $STAGING_NAMESPACE --timeout=60s || echo "ì»¨í”¼ê·¸ë§µ ì‚­ì œ ì‹¤íŒ¨"
            
            # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ
            kubectl delete namespace $STAGING_NAMESPACE --timeout=300s || echo "ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨"
            
            echo "âœ… PR #${{ github.event.number }} ìŠ¤í…Œì´ì§• í™˜ê²½ ì •ë¦¬ ì™„ë£Œ"
          else
            echo "â„¹ï¸ PR #${{ github.event.number }} ìŠ¤í…Œì´ì§• ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
          fi

      - name: Cleanup TTL expired staging environments
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ• TTL ë§Œë£Œëœ ìŠ¤í…Œì´ì§• í™˜ê²½ ì •ë¦¬..."
          
          CURRENT_TIME=$(date +%s)
          
          # TTL ë¼ë²¨ì´ ìˆëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì°¾ê¸°
          kubectl get namespaces -l staging.cleanup/ttl-unix --no-headers -o custom-columns=NAME:.metadata.name | while read namespace; do
            if [ ! -z "$namespace" ]; then
              TTL_UNIX=$(kubectl get namespace $namespace -o jsonpath='{.metadata.labels.staging\.cleanup/ttl-unix}' 2>/dev/null || echo "")
              PR_NUMBER=$(kubectl get namespace $namespace -o jsonpath='{.metadata.labels.staging\.cleanup/pr-number}' 2>/dev/null || echo "unknown")
              
              if [ ! -z "$TTL_UNIX" ] && [ "$CURRENT_TIME" -gt "$TTL_UNIX" ]; then
                echo "â° TTL ë§Œë£Œëœ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë°œê²¬: $namespace (PR: $PR_NUMBER)"
                
                # ë¦¬ì†ŒìŠ¤ ì‚­ì œ
                kubectl delete all --all -n $namespace --timeout=300s || echo "ë¦¬ì†ŒìŠ¤ ì‚­ì œ ì‹¤íŒ¨: $namespace"
                kubectl delete secrets --all -n $namespace --timeout=60s || echo "ì‹œí¬ë¦¿ ì‚­ì œ ì‹¤íŒ¨: $namespace"
                kubectl delete configmaps --all -n $namespace --timeout=60s || echo "ì»¨í”¼ê·¸ë§µ ì‚­ì œ ì‹¤íŒ¨: $namespace"
                
                # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ
                kubectl delete namespace $namespace --timeout=300s || echo "ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨: $namespace"
                
                echo "âœ… ë§Œë£Œëœ ìŠ¤í…Œì´ì§• í™˜ê²½ ì •ë¦¬ ì™„ë£Œ: $namespace"
              else
                echo "â„¹ï¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ $namespace ëŠ” ì•„ì§ TTLì´ ë§Œë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
              fi
            fi
          done

      - name: Cleanup old ECR images
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ—‘ï¸ ì˜¤ë˜ëœ ECR ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          
          # 30ì¼ ì´ìƒ ëœ ì´ë¯¸ì§€ ì‚­ì œ (latestì™€ ìµœê·¼ 10ê°œ ì œì™¸)
          aws ecr list-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --filter tagStatus=TAGGED \
            --query 'imageIds[?imageTag!=`latest`]' \
            --output json | \
          jq -r '.[10:] | .[] | select(.imageTag | test("^pr-")) | .imageDigest' | \
          head -20 | \
          while read digest; do
            if [ ! -z "$digest" ]; then
              echo "ğŸ—‘ï¸ ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì‚­ì œ: $digest"
              aws ecr batch-delete-image \
                --repository-name ${{ env.ECR_REPOSITORY }} \
                --image-ids imageDigest=$digest || echo "ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨: $digest"
            fi
          done
          
          echo "âœ… ECR ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ"

      - name: Summary
        run: |
          echo "ğŸ“Š ì •ë¦¬ ì‘ì—… ìš”ì•½:"
          echo "- í˜„ì¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ëª©ë¡:"
          kubectl get namespaces -l name=nestjs-app || echo "ê´€ë ¨ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì—†ìŒ"
          
          echo "- ECR ì´ë¯¸ì§€ ê°œìˆ˜:"
          aws ecr list-images --repository-name ${{ env.ECR_REPOSITORY }} --query 'length(imageIds)' || echo "ECR ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨"
