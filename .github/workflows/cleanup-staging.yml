name: Cleanup Staging Environment

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region ap-northeast-2 --name nestjs-cluster

      - name: Cleanup staging environment
        run: |
          echo "ğŸ§¹ ìŠ¤í…Œì´ì§• í™˜ê²½ ì •ë¦¬ ì¤‘..."
          
          # ìŠ¤í…Œì´ì§• ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¡´ì¬ í™•ì¸
          if kubectl get namespace nestjs-app-staging > /dev/null 2>&1; then
            echo "ğŸ“¦ ìŠ¤í…Œì´ì§• ë¦¬ì†ŒìŠ¤ ì‚­ì œ ì¤‘..."
            
            # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¼ë²¨ ì •ë³´ ì¶œë ¥
            echo "ğŸ“‹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì •ë³´:"
            kubectl get namespace nestjs-app-staging --show-labels
            
            # ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì‚­ì œ
            kubectl delete all --all -n nestjs-app-staging || echo "ë¦¬ì†ŒìŠ¤ ì‚­ì œ ì‹¤íŒ¨ (ì´ë¯¸ ì‚­ì œë¨)"
            kubectl delete secrets --all -n nestjs-app-staging || echo "ì‹œí¬ë¦¿ ì‚­ì œ ì‹¤íŒ¨"
            kubectl delete configmaps --all -n nestjs-app-staging || echo "ì»¨í”¼ê·¸ë§µ ì‚­ì œ ì‹¤íŒ¨"
            
            # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ
            kubectl delete namespace nestjs-app-staging || echo "ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨"
            
            echo "âœ… ìŠ¤í…Œì´ì§• í™˜ê²½ ì •ë¦¬ ì™„ë£Œ"
          else
            echo "â„¹ï¸ ìŠ¤í…Œì´ì§• ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
          fi

      - name: Cleanup old staging namespaces (TTL based)
        run: |
          echo "ğŸ• TTL ê¸°ë°˜ ì˜¤ë˜ëœ ìŠ¤í…Œì´ì§• í™˜ê²½ ì •ë¦¬..."
          
          # í˜„ì¬ Unix íƒ€ì„ìŠ¤íƒ¬í”„
          CURRENT_TIME=$(date +%s)
          
          # TTLì´ ì§€ë‚œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì°¾ê¸°
          kubectl get namespaces -l staging.cleanup/ttl-unix --no-headers | while read namespace rest; do
            TTL_UNIX=$(kubectl get namespace $namespace -o jsonpath='{.metadata.labels.staging\.cleanup/ttl-unix}' 2>/dev/null || echo "")
            
            if [ ! -z "$TTL_UNIX" ] && [ "$CURRENT_TIME" -gt "$TTL_UNIX" ]; then
              echo "â° TTL ë§Œë£Œëœ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë°œê²¬: $namespace"
              
              # ë¦¬ì†ŒìŠ¤ ì‚­ì œ
              kubectl delete all --all -n $namespace || echo "ë¦¬ì†ŒìŠ¤ ì‚­ì œ ì‹¤íŒ¨"
              kubectl delete secrets --all -n $namespace || echo "ì‹œí¬ë¦¿ ì‚­ì œ ì‹¤íŒ¨"
              kubectl delete configmaps --all -n $namespace || echo "ì»¨í”¼ê·¸ë§µ ì‚­ì œ ì‹¤íŒ¨"
              
              # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ
              kubectl delete namespace $namespace || echo "ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨: $namespace"
              
              echo "âœ… ë§Œë£Œëœ ìŠ¤í…Œì´ì§• í™˜ê²½ ì •ë¦¬ ì™„ë£Œ: $namespace"
            fi
          done

      - name: Cleanup ECR staging images
        run: |
          echo "ğŸ—‘ï¸ ìŠ¤í…Œì´ì§• ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          
          # PR ê´€ë ¨ ì´ë¯¸ì§€ íƒœê·¸ ëª©ë¡ ì¡°íšŒ
          PR_NUMBER=${{ github.event.number }}
          
          # ECRì—ì„œ PR ê´€ë ¨ ì´ë¯¸ì§€ ì‚­ì œ (ìµœê·¼ 5ê°œ ì œì™¸í•˜ê³ )
          aws ecr list-images \
            --repository-name nestjs-app \
            --filter tagStatus=TAGGED \
            --query "imageIds[?starts_with(imageTag, 'pr-${PR_NUMBER}-')]" \
            --output json | \
          jq -r '.[5:] | .[] | .imageDigest' | \
          while read digest; do
            if [ ! -z "$digest" ]; then
              aws ecr batch-delete-image \
                --repository-name nestjs-app \
                --image-ids imageDigest=$digest || echo "ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨: $digest"
            fi
          done
          
          echo "âœ… ìŠ¤í…Œì´ì§• ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ"
